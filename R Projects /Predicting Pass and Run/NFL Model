getwd()
setwd("C:/Users/Vaughn/OneDrive - Indiana University/K353")

library(dplyr)
library(ggplot2)
library(caret)

fbdata <- read.csv("pbp-2024.csv", header = T)
head(fbdata)

pbp_clean <- fbdata %>%
  filter(IsPass == 1 | IsRush == 1) %>%
  filter(IsPenaltyAccepted == 0 | is.na(IsPenaltyAccepted)) %>%  
  select(OffenseTeam, DefenseTeam, Quarter,Minute, Down, ToGo, YardLineFixed,
         IsPass, IsRush, Yards, GameId,Formation)


pbp_clean <- na.omit(pbp_clean)

pbp_clean$YardsToEndzone <- 100 - pbp_clean$YardLineFixed
pbp_clean$IsGoalToGo <- ifelse(pbp_clean$ToGo <= pbp_clean$YardLineFixed & pbp_clean$YardLineFixed <= 10, 1, 0)
pbp_clean$OffenseTeam <- as.factor(pbp_clean$OffenseTeam)
pbp_clean$Quarter <- as.factor(pbp_clean$Quarter)

#Logistic Regression

train_index <- sample(1:nrow(pbp_clean), 0.6 * nrow(pbp_clean))
train_data <- pbp_clean[train_index, ]
valid_data <- pbp_clean[-train_index, ]


model <- glm(IsPass ~ Down + ToGo + YardsToEndzone  + IsGoalToGo+OffenseTeam+Formation+Minute+Quarter+DefenseTeam,
             data = train_data, family = binomial)

summary(model)


valid_data$pred_prob <- predict(model, newdata = valid_data, type = "response")
valid_data$pred_class <- ifelse(valid_data$pred_prob >= 0.5, 1, 0)


conf_matrix <- confusionMatrix(
  factor(valid_data$pred_class, levels = c(0, 1)),
  factor(valid_data$IsPass, levels = c(0, 1))
)
print(conf_matrix)

accuracy <- conf_matrix$overall['Accuracy']
recall <- conf_matrix$byClass['Sensitivity']
precision <- conf_matrix$byClass['Pos Pred Value']

cat("Accuracy:", round(accuracy, 3), "\n")
cat("Recall (Sensitivity):", round(recall, 3), "\n")
cat("Precision:", round(precision, 3), "\n")


barplot(pbp_clean$Down,which(pbp_clean$IsPass == 1))

ggplot(valid_data, aes(x = factor(Down), y = pred_prob)) +
  geom_boxplot(fill = "#3B82F6", alpha = 0.7, color = "black") +
  labs(title = "Predicted Probability of Pass by Down",
       x = "Down", y = "Predicted Probability of Pass") +
  theme_minimal(base_size = 13)

#K-Means Clustering

team_summary <- pbp_clean %>%
  group_by(OffenseTeam) %>%
  summarize(
    PassRate_Overall = mean(IsPass),
    PassRate_1st = mean(IsPass[Down == 1], na.rm = TRUE),
    PassRate_3rd = mean(IsPass[Down == 3], na.rm = TRUE),
    PassRate_RedZone = mean(IsPass[YardsToEndzone <= 20], na.rm = TRUE),
    AvgYardsToEndzone = mean(YardsToEndzone)
  )

team_scaled <- scale(team_summary[, -1])


set.seed(123)
kmodel <- kmeans(team_scaled, centers = 2, nstart = 25)


team_summary$Cluster <- kmodel$cluster


print(team_summary)


ggplot(team_summary, aes(x = PassRate_Overall,
                         y = PassRate_RedZone,
                         color = factor(Cluster),
                         label = OffenseTeam)) +
  geom_point(size = 4) +
  geom_text(nudge_y = 0.015) +
  labs(title = "NFL Team Clusters Based on Play-Calling Tendencies",
       x = "Overall Pass Rate",
       y = "Red Zone Pass Rate",
       color = "Cluster") +
  theme_minimal()

wss <- sapply(1:6, function(k) {
  kmeans(team_scaled, centers = k, nstart = 25)$tot.withinss
})

plot(1:6, wss, type = "b",
     xlab = "Number of Clusters (k)",
     ylab = "Total Within-Cluster Sum of Squares",
     main = "Elbow Method for Choosing k")
